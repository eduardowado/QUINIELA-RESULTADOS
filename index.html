<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados y Saldos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }

        /* Botón Regreso Fijo */
        .btn-regreso-fijo {
            position: fixed; top: 20px; right: 20px;
            background-color: #ffcc80; color: #5d4037; border: 2px solid #ffffff; text-decoration: none;
            padding: 10px 15px; border-radius: 30px; font-family: sans-serif; font-weight: bold; font-size: 14px;
            z-index: 9999; box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
        }
        .btn-regreso-fijo:hover { background-color: #ffb74d; transform: scale(1.05); }

        .container { max-width: 95%; margin: 20px auto; padding: 0 15px; }

        header {
            background-color: #2c3e50; color: white; padding: 20px 25px;
            border-radius: 12px 12px 0 0; display: flex;
            justify-content: space-between; align-items: center;
        }
        header h1 { margin: 0; font-size: 1.4em; }

        #btn-logout { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: 700; font-size: 0.9em; cursor: pointer; }

        #login-screen { padding: 30px; text-align: center; background: #fff; border-radius: 12px; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.07); margin-top: 50px; max-width: 400px; margin-left: auto; margin-right: auto; }
        #main-content { display: none; background: #fff; border-radius: 0 0 12px 12px; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.07); overflow: hidden; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 6px; }
        input[type="text"], input[type="password"], select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; }

        button { padding: 12px 20px; font-size: 1em; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        button.btn-primary { background-color: #3498db; color: white; }
        button.btn-primary:hover { background-color: #2980b9; }

        .tab-nav { display: flex; background-color: #ecf0f1; overflow-x: auto; }
        .tab-button { padding: 14px 15px; cursor: pointer; background-color: transparent; border: none; color: #7f8c8d; font-size: 0.85em; font-weight: 700; flex-grow: 1; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-button.active { color: #34495e; border-bottom: 3px solid #3498db; }
        .tab-button.hidden { display: none !important; }
        .tab-content { display: none; padding: 25px; }
        .tab-content.active { display: block; }

        /* --- ESTILOS DE TABLAS ORIGINALES --- */
        .table-container { overflow: auto; max-width: 100%; max-height: 70vh; position: relative; }
        table { width: 100%; min-width: 600px; border-collapse: separate; border-spacing: 0; margin-top: 0; }
        th, td { border-bottom: 1px solid #ddd; border-right: 1px solid #ddd; padding: 10px; text-align: center; font-size: 0.9em; white-space: nowrap; background-color: #fff; }

        thead th { position: sticky; top: 0; z-index: 20; background-color: #34495e; color: white; }

        #resultados-publicos-tabla thead tr:nth-child(1) th {
            position: sticky; top: 0; z-index: 20; height: 45px; background-color: #34495e; color: white;
        }

        #resultados-publicos-tabla thead tr:nth-child(2) th,
        #resultados-publicos-tabla thead tr:nth-child(2) td {
            position: sticky; top: 45px; z-index: 20; background-color: #f4f6f8; color: #e74c3c; font-weight: 700;
            box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
        }

        #resultados-publicos-tabla th:first-child,
        #resultados-publicos-tabla td:first-child {
            position: sticky; left: 0; z-index: 15; border-right: 2px solid #bbb; background-color: #fff;
        }

        #resultados-publicos-tabla thead tr:nth-child(1) th:first-child { z-index: 30; left: 0; top: 0; background-color: #34495e; }
        #resultados-publicos-tabla thead tr:nth-child(2) th:first-child { z-index: 30; left: 0; top: 45px; background-color: #f4f6f8; color: #e74c3c; }

        #resultados-publicos-tabla tbody td:first-child { font-weight: 700; color: #2c3e50; text-align: left; }

        .puntos-total-banner { background-color: #eaf2f8; border: 1px solid #bdc3c7; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; color: #2c3e50; }
        .comodin-cell { border: 2px solid #f1c40f !important; position: relative; background-color: #fff9db !important; }
        .comodin-cell::after { content: '★'; position: absolute; top: -6px; right: -6px; color: #f1c40f; background: #fff; border-radius: 50%; width: 14px; height: 14px; font-size: 12px; line-height: 14px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        .saldos-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .saldo-card { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 20px; text-align: center; }
        .saldo-card .valor { font-size: 2.2em; font-weight: 700; }
        .saldo-card .valor.debe { color: #e74c3c; }
        .saldo-card .valor.pagado { color: #2ecc71; }
        .saldo-card .valor.disponible { color: #3498db; }

        #loader { display: none; text-align: center; margin: 20px 0; font-weight: 500; color: #3498db; }
        #mensaje-login { padding: 15px; margin-top: 15px; border-radius: 6px; display: none; font-weight: 500; }
        #mensaje-login.error { background-color: #f8d7da; color: #721c24; }

        @media (max-width: 600px) {
            .container { margin: 0; padding: 0; }
            .tab-nav { font-size: 0.8em; }
            .tab-button { padding: 12px 10px; }
            .tab-content { padding: 15px; }
            .saldos-container { grid-template-columns: 1fr; }
            .table-container { max-height: 75vh; }
        }
    </style>
</head>

<body>
<a href="https://eduardowado.github.io/Bienvenido-Quinelas-De-La-Fuente/" class="btn-regreso-fijo">↩ Regresar</a>
    <div class="container">
        <div id="login-screen">
            <h2>Resultados, Tablas y Saldos</h2>
            <p>Ingresa tu código de temporada o semanal.</p>
            <div class="form-group">
                <label for="login-codigo">Código de Acceso:</label>
                <input type="password" id="login-codigo" placeholder="Ej. 1234">
            </div>
            <button id="btn-login" class="btn-primary" style="width:100%;">Entrar</button>
            <div id="mensaje-login"></div>
        </div>
        <div id="main-content">
            <header>
                <h1 id="welcome-message">¡Hola, Jugador!</h1>
                <button id="btn-logout">Salir</button>
            </header>
            <nav class="tab-nav">
                <button class="tab-button active" data-tab="tab-mis-resultados">Mis Resultados</button>
                <button class="tab-button" data-tab="tab-resultados-publicos">Resultados Globales</button>
                <button class="tab-button" id="btn-tab-general" data-tab="tab-tabla-general">Tabla General</button>
                <button class="tab-button" data-tab="tab-saldos">Mis Saldos</button>
            </nav>
            
            <div id="tab-mis-resultados" class="tab-content active">
                <h2>Mis Aciertos por Jornada</h2>
                <div class="form-group" style="max-width: 300px;">
                    <label>Selecciona Jornada:</label>
                    <select id="jornada-select-mis-resultados">
                        <option value="1">Jornada 1</option><option value="2">Jornada 2</option><option value="3">Jornada 3</option>
                        <option value="4">Jornada 4</option><option value="5">Jornada 5</option><option value="6">Jornada 6</option>
                        <option value="7">Jornada 7</option><option value="8">Jornada 8</option><option value="9">Jornada 9</option>
                        <option value="10">Jornada 10</option><option value="11">Jornada 11</option><option value="12">Jornada 12</option>
                        <option value="13">Jornada 13</option><option value="14">Jornada 14</option><option value="15">Jornada 15</option>
                        <option value="16">Jornada 16</option><option value="17">Jornada 17</option>
                    </select>
                </div>

                <div class="puntos-total-banner">
                    <h3 id="mis-puntos-total-display">Total Puntos: 0</h3>
                    <div id="mis-goles-display" class="info-goles">Cargando goles...</div>
                </div>

                <div class="table-container">
                    <table id="mis-resultados-tabla">
                        <thead>
                            <tr><th>Partido</th><th>Mi Pronóstico</th><th>Resultado Real</th><th>Puntos</th></tr>
                        </thead>
                        <tbody id="mis-resultados-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-resultados-publicos" class="tab-content">
                <h2>Resultados de Todos (Global)</h2>
                <div class="form-group" style="max-width: 300px;">
                    <label>Selecciona Jornada:</label>
                    <select id="jornada-select-publica">
                        <option value="1">Jornada 1</option><option value="2">Jornada 2</option><option value="3">Jornada 3</option>
                        <option value="4">Jornada 4</option><option value="5">Jornada 5</option><option value="6">Jornada 6</option>
                        <option value="7">Jornada 7</option><option value="8">Jornada 8</option><option value="9">Jornada 9</option>
                        <option value="10">Jornada 10</option><option value="11">Jornada 11</option><option value="12">Jornada 12</option>
                        <option value="13">Jornada 13</option><option value="14">Jornada 14</option><option value="15">Jornada 15</option>
                        <option value="16">Jornada 16</option><option value="17">Jornada 17</option>
                    </select>
                </div>
                <p style="font-size: 0.8em; color: #666;">★ = Comodín</p>
                <div class="table-container">
                    <table id="resultados-publicos-tabla">
                        <thead id="resultados-publicos-thead"></thead>
                        <tbody id="resultados-publicos-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="tab-tabla-general" class="tab-content">
                <h2>Tabla General (Temporada)</h2>
                <div class="table-container">
                    <table id="tabla-general-tabla">
                        <thead><tr><th>#</th><th>Nombre</th><th>Total</th></tr></thead>
                        <tbody id="tabla-general-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="tab-saldos" class="tab-content">
                <h2>Mis Saldos</h2>
                <div class="saldos-container">
                    <div class="saldo-card" id="saldo-temporada-card">
                        <h3>Quiniela de Temporada</h3>
                        <p id="saldo-temporada-pagado" class="valor pagado">$0.00</p>
                        <p style="font-size: 0.9em; color: #555;">Total Pagado</p>
                        <p id="saldo-temporada-debe" class="valor debe">$0.00</p>
                        <p style="font-size: 0.9em; color: #555;">Saldo Pendiente</p>
                    </div>
                    <div class="saldo-card" id="saldo-semanal-card">
                        <h3>Quinielas Semanales</h3>
                        <p id="saldo-semanal-disponible" class="valor disponible">0</p>
                        <p style="font-size: 0.9em; color: #555;">Disponibles</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="loader">Cargando...</div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJjZecSugJuwwhOOHtJPSgBSZ40tVsbkcff43awD_2weuJp0KEe1FolTIWnf-qpJi7/exec"
        
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const loginCodigoInput = document.getElementById('login-codigo');
        const btnLogin = document.getElementById('btn-login');
        const btnLogout = document.getElementById('btn-logout');
        const welcomeMessage = document.getElementById('welcome-message');
        const mensajeLogin = document.getElementById('mensaje-login');
        const loader = document.getElementById('loader');

        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');

        const jornadaSelectMisRes = document.getElementById('jornada-select-mis-resultados');
        const jornadaSelectPublica = document.getElementById('jornada-select-publica');
        const btnTabGeneral = document.getElementById('btn-tab-general');
        const saldoTemporadaCard = document.getElementById('saldo-temporada-card');

        document.addEventListener('DOMContentLoaded', () => {
            const nombre = sessionStorage.getItem('nombreUsuario');
            if (nombre) mostrarPanel(nombre, sessionStorage.getItem('esSoloSemanal') === 'true');
        });

        btnLogin.addEventListener('click', async () => {
            const codigo = loginCodigoInput.value;
            if (!codigo) { mostrarMensajeLogin('error', 'Ingresa tu código.'); return; }
            mostrarLoader(true);
            const formData = new FormData();
            formData.append('accion', 'loginParticipante');
            formData.append('codigo', codigo);
            try {
                const res = await fetch(SCRIPT_URL, {method:'POST', body:formData});
                const data = await res.json();
                if(data.status !== 'ok') throw new Error(data.message);
                sessionStorage.setItem('nombreUsuario', data.nombre);
                const esSoloSemanal = (!data.codigoTemp || data.codigoTemp === "");
                sessionStorage.setItem('codigoTemp', data.codigoTemp || ""); 
                sessionStorage.setItem('codigoSem', data.codigoSem || "");
                sessionStorage.setItem('esSoloSemanal', esSoloSemanal);
                mostrarPanel(data.nombre, esSoloSemanal);
            } catch (err) { mostrarMensajeLogin('error', err.message); }
            finally { mostrarLoader(false); }
        });

        btnLogout.addEventListener('click', () => { sessionStorage.clear(); location.reload(); });

        function mostrarPanel(nombre, esSoloSemanal) {
            loginScreen.style.display = 'none'; mainContent.style.display = 'block';
            welcomeMessage.textContent = `¡Hola, ${nombre}!`;
            if (esSoloSemanal) {
                btnTabGeneral.classList.add('hidden'); saldoTemporadaCard.style.display = 'none'; 
            } else {
                btnTabGeneral.classList.remove('hidden'); saldoTemporadaCard.style.display = 'block';
            }
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="tab-mis-resultados"]').classList.add('active');
            document.getElementById('tab-mis-resultados').classList.add('active');
            cargarMisResultados(); 
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                cargarPestañaActiva();
            });
        });

        function cargarPestañaActiva() {
            const tabActiva = document.querySelector('.tab-button.active').dataset.tab;
            if (tabActiva === 'tab-mis-resultados') cargarMisResultados();
            else if (tabActiva === 'tab-resultados-publicos') cargarResultadosPublicos();
            else if (tabActiva === 'tab-tabla-general') cargarTablaGeneral();
            else if (tabActiva === 'tab-saldos') cargarMisSaldos();
        }

        jornadaSelectMisRes.addEventListener('change', cargarMisResultados);
        jornadaSelectPublica.addEventListener('change', cargarResultadosPublicos);

        async function cargarMisResultados() {
            const formData = new FormData();
            formData.append('accion', 'getMisResultados');
            formData.append('jornada', jornadaSelectMisRes.value);
            formData.append('codigoTemp', sessionStorage.getItem('codigoTemp'));
            formData.append('codigoSem', sessionStorage.getItem('codigoSem'));
            try {
                const res = await fetch(SCRIPT_URL, {method:'POST', body:formData});
                const data = await res.json();
                document.getElementById('mis-puntos-total-display').textContent = `Total Puntos: ${data.totalPuntos}`;
                let textoGoles = `Goles: ${data.miTotalGoles} (Tú) vs ${data.realTotalGoles} (Real)`;
                if (String(data.realTotalGoles) !== "-" && String(data.miTotalGoles) === String(data.realTotalGoles)) textoGoles += " ✅ (+3 pts)";
                document.getElementById('mis-goles-display').innerHTML = textoGoles;
                let tbody = document.getElementById('mis-resultados-tbody');
                tbody.innerHTML = '';
                data.comparativa.forEach((item, index) => {
                    let esComodin = (index + 1) === data.miComodin;
                    let style = item.puntos >= 3 ? 'background:#d4edda;' : item.puntos > 0 ? 'background:#fff3cd;' : '';
                    tbody.innerHTML += `<tr><td>${item.partido}</td><td>${item.pronostico}</td><td style="font-weight:bold;">${item.real}</td><td class="${esComodin?'comodin-cell':''}" style="${style}">${item.puntos}</td></tr>`;
                });
            } catch (e) { }
        }

        async function cargarResultadosPublicos() {
            const esSoloSemanal = sessionStorage.getItem('esSoloSemanal') === 'true';
            const formData = new FormData();
            formData.append('accion', 'getResultadosPublicos');
            formData.append('jornada', jornadaSelectPublica.value);
            try {
                const res = await fetch(SCRIPT_URL, {method:'POST', body:formData});
                const data = await res.json();
                let thead = document.getElementById('resultados-publicos-thead');
                let tbody = document.getElementById('resultados-publicos-tbody');
                
                let h1 = '<tr><th class="td-jugador">Participante</th>';
                data.partidos.forEach((p, i) => { h1 += `<th colspan="3">P${i+1}: ${p.local} vs ${p.visita}</th>`; });
                h1 += '<th>Goles</th><th>Pts</th></tr>';

                let h2 = '<tr><th>RESULTADO REAL</th>';
                data.resultadosReales.forEach((r, i) => {
                    if (i % 2 === 0) {
                        const val = (r!=="" || data.resultadosReales[i+1]!=="") ? r+'-'+data.resultadosReales[i+1] : '-';
                        h2 += `<td colspan="3">${val}</td>`;
                    }
                });
                h2 += `<td>${data.realTotalGoles}</td><td>-</td></tr>`;
                thead.innerHTML = h1 + h2;

                tbody.innerHTML = '';
                data.tabla.forEach(jug => {
                    let tipoRival = (jug.tipoJugador || "").toLowerCase().trim();
                    
                    // MEJORA: FILTRO PARA MOSTRAR "AMBOS"
                    if (esSoloSemanal) { 
                        if (tipoRival !== 'semanal' && tipoRival !== 'ambos') return; 
                    } else { 
                        if (tipoRival !== 'temporada' && tipoRival !== 'ambos') return; 
                    }

                    let row = `<tr><td>${jug.nombre}</td>`;
                    let comodinIdx = (jug.comodinIdx) ? (parseInt(jug.comodinIdx) - 1) : -1;
                    for (let p=0; p<9; p++) {
                        let pts = jug.puntos[p];
                        let bg = (pts>=3)?'#d4edda':(pts>=1)?'#fff3cd':'#fff';
                        row += `<td>${jug.pronosticos[p*2]}</td><td>${jug.pronosticos[p*2+1]}</td><td class="${p===comodinIdx?'comodin-cell':''}" style="background:${bg}">${pts}</td>`;
                    }
                    row += `<td>${jug.totalGoles}</td><td style="font-weight:bold; background:#3498db; color:white;">${jug.totalPuntos}</td></tr>`;
                    tbody.innerHTML += row;
                });
            } catch (e) { }
        }

        async function cargarTablaGeneral() {
            const formData = new FormData(); formData.append('accion', 'getTablaGeneral');
            try {
                const res = await fetch(SCRIPT_URL, {method:'POST', body:formData});
                const data = await res.json();
                let head = '<th>#</th><th>Nombre</th>';
                for(let i=1; i<=17; i++) head += `<th>J${i}</th>`;
                head += '<th>Total</th>';
                document.querySelector('#tabla-general-tabla thead tr').innerHTML = head;
                let b = '';
                data.tabla.forEach((row, i) => {
                    b += `<tr><td><b>${i+1}</b></td>${row.map(c => `<td>${c}</td>`).join('')}</tr>`;
                });
                document.getElementById('tabla-general-tbody').innerHTML = b;
            } catch (e) { }
        }

        async function cargarMisSaldos() {
            const formData = new FormData();
            formData.append('accion', 'getMisSaldos');
            formData.append('codigoTemp', sessionStorage.getItem('codigoTemp'));
            formData.append('codigoSem', sessionStorage.getItem('codigoSem'));
            try {
                const res = await fetch(SCRIPT_URL, {method:'POST', body:formData});
                const data = await res.json();
                const f = new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'});
                if (data.saldos.temporada) {
                    document.getElementById('saldo-temporada-pagado').textContent = f.format(data.saldos.temporada.pagado);
                    let el = document.getElementById('saldo-temporada-debe');
                    el.textContent = f.format(data.saldos.temporada.debe);
                    el.className = data.saldos.temporada.debe > 0 ? 'valor debe' : 'valor pagado';
                }
                document.getElementById('saldo-semanal-disponible').textContent = data.saldos.semanal ? data.saldos.semanal.saldo : 0;
            } catch (e) { }
        }

        function mostrarLoader(s) { loader.style.display = s ? 'block' : 'none'; }
        function mostrarMensajeLogin(t, m) {
            if(!t) { mensajeLogin.style.display='none'; return; }
            mensajeLogin.className = t; mensajeLogin.textContent = m; mensajeLogin.style.display='block';
        }
    </script>
</body>
</html>
